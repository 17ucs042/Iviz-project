<!doctype html>
<html lang="en">

<head>
    <!-- Required meta tags -->
    <meta charset="utf-8">

    <title>Crimes State Wise</title>
    <link rel="preconnect" href="https://fonts.gstatic.com">
    <link href="https://fonts.googleapis.com/css2?family=Poppins&display=swap" rel="stylesheet">    

    <style>
        #loading {
            width: 100%;
            height: 100%;
            top: 0;
            left: 0;
            position: fixed;
            display: block;
            opacity: 1;
            background-color: #fff;
            z-index: 99;
            text-align: center;
        }

        #loading-image {
            position: absolute;
            top: 30%;
            left: 45%;
            z-index: 100;
        }

        header {
            height: 70px;
            padding-top: 40px;
            z-index: 2;
            box-shadow: 0 3px 6px 0 rgba(0, 0, 0, 0.05);
            display: flex;
            align-items: flex-end;
            justify-content: center;
        }

        select{
            display: block;
            width: 200px;
            color:#58595b;
            font-weight: normal;
            font-size: 16px;
            font-family: "Arial", sans-serif;
            padding:5px;
            margin-top:5px;
            margin-bottom: 10px;
            background: #fff;       
            box-shadow: 0px 0px 7px  rgba(0, 0, 0, 0.33);
            outline: none;
            border: none;
            resize:none;
        }

        path:hover{
            fill: #9dbcd4;
        }

        rect:hover{
            fill:#9dbcd4;
        }
    </style>
</head>
<body>
    <div id="loading" style="text-align: center;">
        <img id="loading-image" src="assets/images/ajax-loader.webp" alt="Loading..." />
    </div>

    <header>
        <div style="text-align:center">
            <nav class="navbar">
                <h1 style="font-size: 40px;font-family:Poppins;">Rape Cases in India</h1>
            </nav>
        </div>
    </header>
    
    <div style="text-align:center;margin-top:50px;">
        <form id="yearForm">
            <label for="year" style="font-size: 16px;font-family:Poppins;">Choose a year:</label><br>
            <div style="display:flex;justify-content: center;">
                <select id="year" name="year">
                    <option value="2001">2001</option>
                    <option value="2002">2002</option>
                    <option value="2003">2003</option>
                    <option value="2004">2004</option>
                    <option value="2005">2005</option>
                    <option value="2006">2006</option>
                    <option value="2007">2007</option>
                    <option value="2008">2008</option>
                    <option value="2009">2009</option>
                    <option value="2010">2010</option>
                    <option value="2011">2011</option>
                    <option value="2012">2012</option>
                </select>
            </div>
            <input type="submit">
        </form>
    </div>
    
    <div style="display: flex;margin-top:50px;">
        <div style="text-align:start;">
            <svg id="barChart" width = 900 height = 900 style="border: 2px solid black;">
            </svg>
        </div>

        <div>
            <div style="text-align: center; border: 2px solid black;position:relative;">
                <div id="legend1" style="position:absolute;right:10px;top:5px;font-family:Poppins;">Number of Rape Cases in 2001<br></div>
                <svg id="mapOld" height="445" width="600"></svg>
            </div>
            <div style="text-align: center; border: 2px solid black;position:relative;">
                <div id="legend2" style="position:absolute;right:10px;top:5px;font-family:Poppins;">Number of Rape Cases in 2018<br></div>
                <svg id ="map2018" height = "445" width = "600"></svg>
            </div>
        </div>
    </div>

    <script src = "assets/js/d3.js"></script>

    <!-- Old Map -->
    <script>
        let year = 2001;
        let mapOld = d3.select("#mapOld");
        let oldData;

        Promise.all([
            d3.csv("assets/data/crimes_2001-2012.csv"),
            d3.json("assets/data/states_india.geo.json"),
        ]).then(showOldMap);
        
        function showOldMap(myData) {
            oldData = myData;
            createOldMap();
        }

        function createOldMap(){
            let crimeInfo = oldData[0];
            let mapInfo = oldData[1];

            crimeInfo = crimeInfo.filter(function(d){
                if (d['CRIME HEAD'] != 'RAPE' || d['STATE/UT'] == "All India") {
                    return false; // skip
                }
                return true;
            });

            let projection = d3.geoMercator()
                            .scale(730)
                            .translate([-800, 520]);

            let path = d3.geoPath().projection(projection);
            
            let dataIndex = {};
        
            for(let c of crimeInfo){
                let state = c["STATE/UT"];
                dataIndex[state] = +c[year];
            }

            mapInfo.features = mapInfo.features.map(d=>{
                let state = d.properties.st_nm;
                let cases = dataIndex[state];
                d.properties.Cases = cases;
                return d;
            });

            let maxCases = d3.max(mapInfo.features, d => d.properties.Cases);
            let midCases = d3.median(mapInfo.features, d => d.properties.Cases);

            let scale = d3.scaleLinear()
                        .domain([0, midCases, maxCases])
                        .range(["white", "#FF5252", "#A70000"]);

            mapOld.selectAll("path").remove();
            mapOld.selectAll("path").data(mapInfo.features)
                .enter()
                .append("path")
                .attr("d", path)
                .attr("stroke", "#3C0000")
                .attr("fill", d => d.properties.Cases ? scale(d.properties.Cases) : "black")
                .append('title')
                .text(d => d.properties.st_nm + ": " + (d.properties.Cases ? d.properties.Cases : 'Not Available'));

            //legend structure
            let w = 300, h = 50;

            let key = d3.select("#legend1")
                        .append("svg")
                        .attr("width", w)
                        .attr("height", h);
        
            let legend = key.append("defs")
                            .append("svg:linearGradient")
                            .attr("id", "gradient")
                            .attr("x1", "0%")
                            .attr("y1", "100%")
                            .attr("x2", "100%")
                            .attr("y2", "100%")
                            .attr("spreadMethod", "pad").attr("data-style-padding", 20);

            legend.append("stop")
                    .attr("offset", "0%")
                    .attr("stop-color", "#FFBABA")
                    .attr("stop-opacity", 1);

            legend.append("stop")
                    .attr("offset", "50%")
                    .attr("stop-color", "#FF5252")
                    .attr("stop-opacity", 1);

            legend.append("stop")
                    .attr("offset", "100%")
                    .attr("stop-color", "#A70000")
                    .attr("stop-opacity", 1);

            key.append("rect")
                .attr("width", w)
                .attr("height", h - 30)
                .style("fill", "url(#gradient)")
                .attr("transform", "translate(0,10)");

            let y = d3.scaleLinear()
                        .range([0, 300])
                        .domain([0, maxCases]);

            let yAxis = d3.axisBottom()
                            .scale(y)
                            .ticks(5);

            d3.select('#legendTicks').remove();
            key.append("g")
                .attr("transform", "translate(1,30)")
                .call(yAxis)
                .attr('id','legendTicks');
        }
    </script>

    <!-- 2018 Map -->
    <script>
        let map2018 = d3.select("#map2018");

        Promise.all([
            d3.csv("assets/data/crimes_2018.csv"),
            d3.json("assets/data/states_india.geo.json")
        ]).then(show2018Map);

        function show2018Map(myData) {
            let crimeInfo = myData[0];
            let mapInfo = myData[1];
            console.log(mapInfo);

            let dataIndex = {};
            for(let c of crimeInfo){
                let state = c['State/UT'];
                dataIndex[state] = +c['Rape (Total) (Sec.376 IPC)'];
            }

            mapInfo.features = mapInfo.features.map(d => {
                let state = d.properties.st_nm;
                let cases = dataIndex[state];
                d.properties.Cases = cases;
                return d;
            });
            
            let maxCases = d3.max(mapInfo.features, d => d.properties.Cases);
            let midCases = d3.median(mapInfo.features, d => d.properties.Cases);

            let cScale = d3.scaleLinear()
                    .domain([0, midCases, maxCases])
                    .range(["white", "#FF5252", "#A70000"]);

            let myProjection = d3.geoMercator()
                                    .scale(730)
                                    .translate([-800, 520]);

            let geoPath = d3.geoPath().projection(myProjection);

            map2018.selectAll("path")
                .data(mapInfo.features)
                .enter()
                .append("path")
                .attr("d",d => geoPath(d))
                .attr("stroke","#3C0000")  
                .attr("fill",d => cScale(d.properties.Cases))
                .append('title')
                .text(d => d.properties.st_nm + ": " + (d.properties.Cases ? d.properties.Cases : 'Not Available'));

            let w = 300, h = 50;

            let key = d3.select("#legend2")
                            .append("svg")
                            .attr("width", w)
                            .attr("height", h);
        
            let legend = key.append("defs")
                                .append("svg:linearGradient")
                                .attr("id", "gradient")
                                .attr("x1", "0%")
                                .attr("y1", "100%")
                                .attr("x2", "100%")
                                .attr("y2", "100%")
                                .attr("spreadMethod", "pad").attr("data-style-padding", 20);

            legend.append("stop")
                    .attr("offset", "0%")
                    .attr("stop-color", "white")
                    .attr("stop-opacity", 1);

            legend.append("stop")
                    .attr("offset", "50%")
                    .attr("stop-color", "#FF5252")
                    .attr("stop-opacity", 1);

            legend.append("stop")
                    .attr("offset", "100%")
                    .attr("stop-color", "#A70000")
                    .attr("stop-opacity", 1);

            key.append("rect")
                .attr("width", w)
                .attr("height", h - 30)
                .style("fill", "url(#gradient)")
                .attr("transform", "translate(0,10)");

            let y = d3.scaleLinear()
                        .range([0, 300])
                        .domain([0, maxCases]);

            let yAxis = d3.axisBottom()
                            .scale(y)
                            .ticks(5);

            key.append("g")
                .attr("transform", "translate(1,30)")
                .call(yAxis);

            d3.select('#loading').style('display','none');
        }
    </script>

    <!-- Bar Chart -->
    <script>
        let filteredData2018;
        let filteredDataCurrent;
        let states;
        let yScale;
        let barChart = d3.select('#barChart');

        Promise.all([
            d3.csv("assets/data/crimes_2001-2012.csv"),
            d3.csv("assets/data/crimes_2018.csv")
        ]).then(showData);
        
        function showData(myData){
            filteredData2018 = myData[1].filter(function(d){
                if ((d['Category'] == "State" || d['Category'] == "Union Territory") && d['State/UT'] != "Total UT(s)" && d['State/UT'] != "Total State(s)") {
                    return true;
                }
                return false; // skip
            });

            filteredDataCurrent = myData[0].filter(function(d) {
                if (d['CRIME HEAD'] != 'RAPE' || d['STATE/UT'] == "All India") {
                    return false; // skip
                }
                return true;
            });

            states = d3.map(filteredData2018, d => d['State/UT']);

            yScale = d3.scaleBand()
                            .domain(states)
                            .range([700, 0])
                            .padding(0.6);

            let yAxis1 = d3.axisLeft(yScale);
            barChart.append('g').call(yAxis1).style("transform","translate(180px,100px)").attr("id", "yAxis1");

            showPercentChange();
        }

        function showPercentChange(){
            let crimes = {};
            for(let c of filteredData2018){
                let state = c['State/UT'];
                crimes[state] = +c['Rape (Total) (Sec.376 IPC)'];
            }

            for(let c of filteredDataCurrent){
                let state = c['STATE/UT'];
                if(c[year] == 0) {
                    crimes[state] = crimes[state]*100;
                }else{
                    crimes[state] = +((((crimes[state] - +c[year])/+c[year])*100).toFixed(2));
                }
            }

            let maxValue = Number.MIN_VALUE;
            let minValue = Number.MAX_VALUE;

            for(let c in crimes){
                if(maxValue < crimes[c]) {
                    maxValue = crimes[c];
                }
                
                if(minValue > crimes[c]) {
                    minValue = crimes[c];
                }
            }

            let xScale = d3.scaleLinear()
                                .domain([-1 * maxValue, maxValue])
                                .range([-300, 300]);

            let xAxis = d3.axisTop(xScale);
            d3.select('#xAxis').remove();
            barChart.append('g').call(xAxis).style("transform","translate(480px,100px)").attr("id", "xAxis");

            let yAxis2 = d3.axisRight(yScale);
            d3.select('#yAxis2').remove();
            barChart.append('g').call(yAxis2).style("transform","translate(480px,100px)").attr("id", "yAxis2");
            d3.select("#yAxis2").selectAll("g").remove();

            d3.select('#yAxis2').selectAll('rect')
                .data(states)
                .enter()
                .append('rect')
                .attr('height', 2 * yScale.bandwidth())
                .style('transform', d => xScale(crimes[d]) < 0 ? 'translate(' + xScale(crimes[d]) + 'px, 0px' : 'none')
                .attr("fill", d => crimes[d] > 0 ? '#DA0000' : '#4984b8')
                .attr('y', d => yScale(d))
                .attr('width', d => xScale(crimes[d]) > 0 ? xScale(crimes[d]) : -1*xScale(crimes[d]))
                .append('title')
                .text(d =>d + ': ' + crimes[d] + "%");


            d3.select('#x-label').remove();
            barChart.append("text")
                .attr('id', 'x-label')
                .attr("text-anchor", "middle")
                .attr("x", 480)
                .attr("y", 40)
                .text("Percent increase in Rape cases between " + year +" and 2018")
                .style('font-size','24px')
                .style('font-family', 'Poppins');

            barChart.append("text")
                .attr("text-anchor", "end")
                .attr("x", -350)
                .attr("y", 60)
                .attr("transform", "rotate(-90)")
                .text("States/UT of India")
                .style('font-size','24px')
                .style('font-family', 'Poppins');
                
        }
    </script>

    <script>
        d3.select('#yearForm').on('submit',function(e){
            e.preventDefault();
            year = document.querySelector('#year').value;
            showPercentChange();
            d3.select('#legend1').html('Number of Rape Cases in ' + year + ' <br>');
            createOldMap();
        });
    </script>
</body>

</html>